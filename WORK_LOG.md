# 작업 로그

## 2026-02-20: 이메일 자동 처리 시스템 구축

### 📋 작업 개요
네이버 이메일로 수신되는 주문서 엑셀 파일을 자동으로 다운로드하고 처리하는 시스템 구축

### ✅ 완료된 작업

#### 1. 이메일 감시 시스템 구현
- **파일**: `choolgo-watcher/email/imap-watcher.js`
- **기능**:
  - 네이버 IMAP 연결 (imap.naver.com:993)
  - 60초마다 새 메일 폴링
  - 읽지 않은 메일만 처리
  - 자동 재연결 (에러 시 30초 후)
  - 임시 파일 자동 정리 (7일 이상)

#### 2. 첨부파일 자동 처리
- **파일**: `choolgo-watcher/email/attachment-handler.js`
- **기능**:
  - 엑셀 파일만 추출 (.xlsx, .xls)
  - 발신자 기반 채널 자동 분류
  - 안전한 파일명 처리 (특수문자 제거)
  - 타임스탬프 자동 추가 (중복 방지)
  - 최종 폴더에 자동 저장

#### 3. 발신자 규칙 시스템
- **파일**: `choolgo-watcher/email/sender-rules.js`
- **기능**:
  - 정확한 이메일 주소 매칭
  - 도메인 매칭 (@domain.com)
  - 키워드 매칭 (부분 일치)
  - 우선순위 기반 룰 적용
  - 동적 규칙 추가/조회 API

#### 4. choolgo-watcher 통합
- **파일**: `choolgo-watcher/index.js`
- **변경사항**:
  - `dotenv` 로드 추가 (환경변수 지원)
  - `startEmailWatcher()` 자동 시작
  - `stopEmailWatcher()` 종료 처리 (SIGINT/SIGTERM)
  - PM2 재시작 시 자동 활성화

#### 5. 의존성 추가
- **파일**: `choolgo-watcher/package.json`
- **새 패키지**:
  - `dotenv@^16.4.5` - 환경변수 관리
  - `imap@^0.8.19` - IMAP 프로토콜
  - `mailparser@^3.7.1` - 이메일 파싱

#### 6. 보안 설정
- **파일**: `choolgo-watcher/.gitignore`
- **제외 항목**: `.env`, `temp/`, `logs/`, `node_modules/`
- **파일**: `choolgo-watcher/.env.example`
- **템플릿**: 필수 환경변수 목록 및 설명

#### 7. 문서화
- **파일**: `choolgo-watcher/EMAIL_SETUP.md`
- **내용**:
  - 네이버 IMAP 활성화 방법
  - 앱 비밀번호 발급 가이드
  - .env 설정 방법
  - 발신자 규칙 설정 예시
  - 문제 해결 가이드
  - 보안 주의사항
- **파일**: `README.md`
- **추가**: choolgo-watcher 소개 및 이메일 기능 설명

### 🔧 작동 흐름

```
┌─────────────────────┐
│ 네이버 이메일 수신   │ (엑셀 첨부)
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ IMAP 감시 (60초)     │ imap-watcher.js
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 발신자 분석          │ sender-rules.js
│ → 채널 자동 분류     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 첨부파일 다운로드    │ attachment-handler.js
│ → 지정 폴더 저장     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ choolgo-watcher     │ index.js
│ 파일 감시 자동 트리거│
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 파싱 + 재고 차감     │
│ + 택배양식 생성      │
└─────────────────────┘
```

### 📁 생성된 파일 구조

```
choolgo-watcher/
├── email/                           # 새로 추가됨
│   ├── imap-watcher.js              # IMAP 메일 감시
│   ├── attachment-handler.js        # 첨부파일 처리
│   └── sender-rules.js              # 발신자 규칙
├── .env.example                     # 새로 추가됨
├── .gitignore                       # 새로 추가됨
├── EMAIL_SETUP.md                   # 새로 추가됨
├── index.js                         # 수정됨
└── package.json                     # 수정됨
```

### 📝 TODO: 다음 작업

#### 1. 이메일 설정 완료 (사용자 작업)
- [ ] `.env` 파일 생성 및 계정 정보 입력
  ```bash
  cd choolgo-watcher
  cp .env.example .env
  nano .env
  ```
- [ ] 네이버 IMAP 활성화 (메일 설정)
- [ ] 앱 비밀번호 발급 (네이버 계정 > 보안설정)
- [ ] `email/sender-rules.js`에 실제 발신자 규칙 추가

#### 2. 테스트 및 검증
- [ ] `npm install` 의존성 설치
- [ ] `npm start` 수동 실행으로 연결 테스트
- [ ] 테스트 메일 발송 (엑셀 첨부)
- [ ] 첨부파일 자동 다운로드 확인
- [ ] 채널 분류 정확도 검증
- [ ] PM2 재시작 후 자동 시작 확인

#### 3. 운영 환경 배포
- [ ] `npm run pm2:restart` 실행
- [ ] `npm run pm2:logs`로 로그 모니터링
- [ ] 실제 거래처 이메일로 테스트
- [ ] 7일간 안정성 모니터링

#### 4. 개선 사항 (선택)
- [ ] 메일 제목 필터링 추가 (키워드 기반)
- [ ] Slack/Discord 알림 연동
- [ ] 웹 대시보드 (처리된 메일 목록)
- [ ] 여러 이메일 계정 동시 감시
- [ ] 첨부파일 검증 (파일명 패턴, 크기 제한)

### 🐛 알려진 이슈

없음 (신규 기능)

### 🔐 보안 체크리스트

- [x] `.env` 파일 `.gitignore` 등록
- [x] 환경변수로 계정 정보 관리
- [x] 파일명 새니타이징 (특수문자 제거)
- [x] 엑셀 파일만 처리 (화이트리스트)
- [ ] 메일 첨부파일 크기 제한 (미구현)
- [ ] 바이러스 스캔 (미구현)

### 📊 커밋 정보

- **커밋**: `2238927`
- **메시지**: "이메일 자동 처리 시스템 추가"
- **날짜**: 2026-02-20
- **변경**: 9 files changed, 810 insertions(+)

---

## 이전 작업 (참고)

### 2026-02-13: 품목명 매핑 기능
- Firebase `productNameMappings/` 노드 추가
- 미매핑 상품 팝업 구현
- 매핑 테이블 인라인 수정

### 2026-02-09: 금일출고 컬럼 추가
- Firebase `choolgoLogs/{YYYY-MM-DD}/summary` 연동
- 실시간 출고량 표시
- 채널별 상세 툴팁

### 2026-02-08: choolgo-watcher 초기 구축
- 파일 감시 시스템
- 채널별 파서 (아이원, 네이버, 카카오, 팔도감)
- 택배양식 자동 생성
- Firebase 재고 차감

---

**다음 접속 시 확인 사항:**
1. `npm install` 완료 여부
2. `.env` 설정 완료 여부
3. 테스트 메일 발송 결과
4. PM2 로그 이상 유무
